
---

Rejection Sampling（拒绝采样）是一种蒙特卡洛统计方法，用于从难以直接采样的目标分布中生成样本。其核心思想是通过一个易于采样的辅助分布（提议分布）生成候选样本，再通过概率判断决定是否接受这些样本，从而间接逼近目标分布。以下是该技术的综合解析：

---

### **一、基本原理与流程**
1. **核心要素**  
   • **目标分布**（p(x)）：需采样的复杂分布，如无法直接生成样本的复杂概率密度函数。
   • **提议分布**（q(x)）：易于采样的分布（如正态分布），需满足存在常数k，使得k*q(x) ≥ p(x)对所有x成立，即完全覆盖目标分布。
   • **接受概率**：通过计算 $p(x)/(k*q(x))$，生成随机数u∈[0,1]，若u≤该比值则接受样本，否则拒绝。

2. **步骤**  
3. 1. 从q(x)中生成候选样本x；  
4. 2. 计算接受概率α = p(x)/(k*q(x))；  
5. 3. 生成随机数u，若u ≤ α则接受x，否则丢弃；  
6. 4. 重复直至获得足够样本。

---

### **二、应用场景与变种**
1. **统计学与机器学习**  
   • **经典应用**：处理非标准化分布（如双伽马分布），通过提议分布生成样本并筛选。
   • **生成对抗网络（GAN）**：生成器G类似提议分布，判别器D模拟接受概率，但GAN的目标分布由判别器隐式学习，而非显式定义。
   • **大模型后训练**：在LLM（如DeepSeek-R1）中，通过生成多个候选回答，使用奖励模型筛选最优样本（Best-of-N策略），提升数据质量。例如，生成N个答案后保留得分最高的用于监督微调（SFT）。

2. **优化与扩展**  
   • **自适应拒绝采样（ARS）**：通过动态调整提议分布（如分段线性逼近目标分布），减少无效采样，适用于对数凹函数类分布。
   • **投机拒绝（Speculative Rejection）**：在大规模数据生成中提前终止低质量样本的生成，减少计算开销（如16-32倍加速）。

---

### **三、优缺点分析**
1. **优势**  
   • **无需归一化常数**：仅需目标分布与提议分布的比值，避免复杂积分计算。
   • **灵活性**：适用于高维或非标准化分布，可结合规则或模型动态调整标准。
   • **高质量筛选**：在LLM中用于生成高质量训练数据，如DeepSeek-R1通过规则奖励和神经奖励模型筛选60万条高质量样本。

2. **局限性**  
   • **效率依赖匹配度**：若q(x)与p(x)差异大，拒绝率高，计算成本剧增。
   • **高维挑战**：维度增加时，有效样本生成难度指数级上升（维度灾难），常需结合MCMC等方法。

---

### **四、与其他采样技术的对比**
| **方法**            | **特点**                                                                 | **适用场景**               |
|---------------------|-------------------------------------------------------------------------|--------------------------|
| **拒绝采样**          | 依赖提议分布覆盖目标分布，接受/拒绝机制直观                              | 低维空间、显式目标分布        |
| **重要性采样**        | 不拒绝样本，但通过权重修正计算期望值                                     | 积分计算、低拒绝率场景        |
| **MCMC（如Metropolis）** | 通过马尔可夫链逼近目标分布，收敛速度慢但适合高维空间                     | 复杂高维分布、稳态分布收敛     |

---

### **五、总结**
Rejection Sampling通过“试错”机制平衡了采样效率与分布精度，在统计学、生成模型和大模型训练中均有广泛应用。其核心价值在于将复杂采样问题转化为易于操作的接受-拒绝决策，但需结合场景优化提议分布或引入动态调整策略（如自适应方法）以提升效率。对于现代LLM而言，该技术不仅是数据生成的工具，更是提升模型对齐和输出质量的关键手段。



## 举例理解 拒绝性采样

---

**场景比喻**：  
假设你有一个形状奇怪的鱼塘（目标分布），你想抓里面的鱼（采样），但鱼塘太复杂，直接撒网抓鱼很难。于是你找了一个更大的、形状规则的鱼塘（提议分布），把网撒在这个大鱼塘里，然后根据一定规则筛选出你想要的鱼。

---

**步骤解释**：  
1. **撒网**：在规则的大鱼塘里随机撒网，捞出一条鱼（生成一个样本）。  
2. **检查**：看这条鱼是否符合你的要求（是否在目标分布的范围内）。  
   - 符合 → **接受**（这条鱼被保留）。  
   - 不符合 → **拒绝**（扔回鱼塘）。  
3. **重复**：直到抓到足够多的鱼（采样足够多的有效样本）。

---

**核心思想**：  
- 用简单的方式（规则鱼塘）生成候选样本，再通过“接受/拒绝”规则筛选出符合复杂需求的样本。  
- **缺点**：如果目标分布和提议分布差异太大，可能需要撒很多次网才能抓到一条鱼（效率低）。

---

**举个栗子**：  
你想生成一个符合“山峰形状”分布的随机点，但直接生成很难。于是你先在更大的矩形区域内随机撒点，然后只保留落在山峰区域内的点，其他点丢弃。剩下的点就符合你的需求了。

---

**一句话总结**：  
**“广撒网，严筛选”** —— 先大量生成候选样本，再通过规则淘汰不合格的，留下符合目标分布的样本。






## 附加解释

>[!tip]
>特别地，为什么说需要用一个 [0,1]的均匀分布中取一个随机数呢，这个随机数有什么用？


当从建议分布 q(x) 中采样得到 x₀ 后，我们生成一个 [0, 1] 上的均匀分布随机数 u，然后检查是否满足：

u ≤ p(x₀) / (Mq(x₀))*

这里的 _u_ 并不是直接用来比较 _p(x₀)_ 和 _q(x₀)_ 的接近程度的，而是**引入了一个概率性的接受机制**。让我们从两个角度来理解为什么需要它以及它是如何工作的：

**1. 几何/面积角度 (更直观)**

- 想象一下函数图像：_y = p(x)_ 是我们目标分布的（未归一化的）密度曲线，_y = M_q(x)* 是那条始终“覆盖”在 _p(x)_ 上方的建议分布包络曲线。
- 当我们从 _q(x)_ 采样得到一个 _x₀_ 时，这相当于在横轴上根据 _q(x)_ 的权重选定了一个位置 _x₀_。
- 此时，在 _x₀_ 这个点，包络曲线的高度是 _M_q(x₀)*，目标曲线的高度是 _p(x₀)_。
- 现在，考虑在点 _x₀_ 处，纵轴上从 0 到 _M_q(x₀)* 这个区间。我们想以某种方式反映 _p(x₀)_ 在这个区间中所占的“比例”。
- 生成一个 [0, 1] 上的均匀随机数 _u_，然后计算 _v = u * M_q(x₀)_。这个 _v_ 就相当于在 [0, _M_q(x₀)_] 这个垂直区间内均匀随机地选择了一个点的高度。
- 接受条件 _u ≤ p(x₀) / (M_q(x₀))* 变形一下就是 _u * M_q(x₀) ≤ p(x₀)*，也就是 _v ≤ p(x₀)_。
- **这意味着什么？** 我们在由 _y = M_q(x)* 曲线下方和横轴围成的区域内（按 _q(x)_ 加权）随机选择了一个点 (_x₀_, _v_)。然后，我们检查这个点是否同时也落在了 _y = p(x)_ 曲线的下方。如果落在了 _p(x)_ 下方，我们就接受这个 _x₀_；否则就拒绝。
- **为什么这样有效？** 通过这种方式，点 (_x₀_, _v_) 落在 _p(x)_ 下方的概率，正好就正比于 _p(x₀)_ 的值。最终，被接受的 _x₀_ 的分布就会符合 _p(x)_。均匀分布 _u_ 就是实现这个“在垂直方向上随机选择位置，看是否落在目标区域内”的关键工具。
（==可以自己画图看看==）

**2. 概率角度**

- 对于一个给定的采样点 _x₀_，我们希望以一定的概率接受它，这个概率应该能反映 _x₀_ 在目标分布 _p(x)_ 下的可能性大小。
- 我们知道 _p(x₀) / (M_q(x₀))* 这个比值介于 0 和 1 之间（因为 _p(x₀) ≤ M_q(x₀)*）。这个比值可以看作是在 _x₀_ 点，目标密度相对于其包络密度的“相对高度”。
- 我们想设计一个机制，使得接受 _x₀_ 的**概率**恰好等于这个比值 _p(x₀) / (M_q(x₀))*。
- 如何实现“以概率 _P_ 发生某件事”？最简单的方法就是：生成一个 [0, 1] 上的均匀随机数 _u_，如果 _u ≤ P_，则事件发生。
- 在拒绝采样中，这个“事件”就是“接受样本 _x₀_”，“概率 _P_”就是我们想要的接受概率 _p(x₀) / (M_q(x₀))*。
- 所以，通过比较均匀随机数 _u_ 和比值 _p(x₀) / (M_q(x₀))_，我们就精确地实现了：以 _p(x₀) / (M_q(x₀))_ 的概率接受 _x₀_。
- **最终效果：** 那些 _p(x₀)_ 相对于 _M_q(x₀)* 更大的点（即目标分布在该点相对更“高”），其接受概率 _p(x₀) / (M_q(x₀))* 就更大，因此这些 _x₀_ 值就更有可能被接受。反之，_p(x₀)_ 相对较小的点，接受概率低，就更可能被拒绝。这样一来，最终收集到的被接受样本的分布就自然地趋向于 _p(x)_。

**总结:**

均匀分布随机数 _u_ 不是直接比较分布相似度，而是**提供了一个随机的阈值**，用于**实现一个概率性的决策过程**。它确保了对于从建议分布 _q(x)_ 中抽取的每个样本 _x₀_，能够以正比于目标密度 _p(x₀)_ （相对于包络 _M_q(x₀)*）的概率被接受。正是这个概率性的接受/拒绝步骤，使得最终得到的样本集合能够正确地反映目标分布 _p(x)_。